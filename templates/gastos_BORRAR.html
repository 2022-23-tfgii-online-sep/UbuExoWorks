

{% extends "base_template_sincal.html" %}


{% block title %}PAgina inicio gastos{% endblock %}

{% block content2 %}

        <div class="col py-3">


            <h2>Listado de gastos</h2>
            <p class="lead">


                <table id="table" 
                data-toggle="table"
                data-search="true"
                data-filter-control="true" 
                data-show-export="true"
                data-click-to-select="true"
                data-toolbar="#toolbar"
          class="table-responsive table table-striped table-sm">   
          
<!--
                <div class="table-responsive" id="listaGastos">
                    <table class="table table-striped table-sm">  -->
                      <thead>
                        <tr>
                            <th data-field="state" data-checkbox="true"></th>
                            <th data-field="fecha" data-filter-control="input" data-sortable="true">Fecha</th>
                            <th data-field="razon" data-filter-control="select" data-sortable="true">Razon social</th>
                            <th data-field="importe" data-filter-control="select" data-sortable="true">Importe</th>
                            <th data-field="iva" data-sortable="true">IVA</th>
                            <th data-field="cif" data-sortable="true">Cif</th>
                            <th data-field="numeroticket" data-sortable="true">numeroTicket</th>
                            <th data-field="boton" data-sortable="true">numeroTicket</th>
                            <th data-field="foto">Foto</th>
                            <th data-field="validado" data-sortable="true">Validaddo</th>
                        </tr>
                       <!-- <tr>
                            <th scope="col">Fecha</th>
                            <th scope="col">Razon social</th>
                            <th scope="col">Importe</th>
                            <th scope="col">IVA</th>
                            <th scope="col">Cif</th>
                            <th scope="col">numeroTicket</th>
                            <th scope="col">Foto</th>
                            <th scope="col">Validado</th>
                        </tr> -->
                       </thead>  
                       <tbody>   
                        {% set i=0 %}                                 
                        {% for ticket in listaGastos %}
                            {% set i = i + 1 %}
                           <tr>
                               <td class="bs-checkbox "><input data-index={{i}} name="btSelectItem" type="checkbox"></td>
                               <td>{{ticket.fecha}}</td>
                               <td>{{ticket.razonSocial}}</td>
                               <td>{{ticket.importe}}</td>
                               <td>{{ticket.iva}}</td>
                               <td>{{ticket.cif}}</td>
                               <td>{{ticket.numeroTicket}}</td>
                               <td><button type="button" class="btn btn-primary btn-xs"><span class="glyphicon glyphicon-pencil"></span></button></td>
                               <!--<td><img id="image-modal" src="{{ url_for("usuarios_blueprint.cargaTicket", idGasto=ticket.idGasto) }}"
                                    style="max-width:50px" data-target="#myModal" data-toggle="modal"></td> -->
                                <td><button type="button" data-func="dt-add" class="btn btn-primary" data-toggle="modal" data-target="#myModal"
                                        data-gasto={{ ticket.idGasto }}><i class="bi-file-earmark-text"></i></button></td>

                                {% if ticket.validado == True %}
                                    <td><button type="button" class="btn btn-primary" id="valida" data-gasto={{ ticket.idGasto }}
                                        onclick="window.location.href='{{ url_for('usuarios_blueprint.validaTicket', idGasto=ticket.idGasto) }}';">
                                        <i class="bi-check"></i></button></td>
                                {% else %}
                                    <td><button type="button" class="btn btn-secondary" id="valida" data-gasto={{ ticket.idGasto }}
                                        onclick="window.location.href='{{ url_for('usuarios_blueprint.validaTicket', idGasto=ticket.idGasto) }}';">
                                        <i class="bi-x"></i></button></td>
                                {% endif %}
                            </tr>
                        {% endfor %}   
                        </tbody>
                    </table>
                </div>


                    <div id="myModal" class="modal fade" role="dialog" tabindex="-1" aria-labelledby="exModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document" >
                            <div class="modal-content">
                                <div class="modal-body" style="width:500px; height:500px">
                                    <img src="" id="showing" style="width:100%; height:480px"/>
                                </div>
                                <div class="modal-footer">
                                    </div>
                          
                                </div>
                            </div>
                        </div>
                    </div>
                
            <!-- Esta parte no la necesito porque estoy haciendo la validacion en el evento onclick del boton     
                    <script type="text/javascript">
                        const btnValida = document.querySelectorAll("#valida");

                        const validaClick = function (evento) {
                            
                            //console.log("boton pulsado tiene: ", this.dataset.gasto );
                            
                            var idGastoTabla = this.dataset.gasto;
                            //jQuery('myModal').on('show.bs.modal', function(e) {
                                //var img = $(e.relatedTarget).attr('src');
                                console.log('idGastoParametroValida:', idGastoTabla);
                                "{{ url_for('usuarios_blueprint.validaTicket', idGasto='var') }}".replace("var", idGastoTabla)
                               
                                console.log('url:', img);
                                //No coge el idGastoTabla y se lo tengo que añadir aqui.
                                //jQuery('#showing').attr('src', img+idGastoTabla);
                            //});
                            //jQuery('myModal').modal("show");
                        }
                        btnValida.forEach(valida => {    
                            valida.addEventListener("click", validaClick);
                        });
                    </script>
                -->

                <!-- Este script muestra en una modal el ticket -->
                    <script type="text/javascript" nonce="2726c7f26c">
                        const botones = document.querySelectorAll(".btn-primary");

                        const haceClick = function (evento) {
                            
                            //console.log("boton pulsado tiene: ", this.dataset.gasto );
                            
                            var idGastoTabla = this.dataset.gasto;
                            //jQuery('myModal').on('show.bs.modal', function(e) {
                                //var img = $(e.relatedTarget).attr('src');
                                console.log('idGastoParametro:', idGastoTabla);
                                img = "{{ url_for('usuarios_blueprint.cargaTicket', idGasto=idGastoTabla) }}"
                                //No coge el idGastoTabla y se lo tengo que añadir aqui.
                                jQuery('#showing').attr('src', img+idGastoTabla);
                            //});
                            jQuery('myModal').modal("show");
                        }
                        //añadimos un controlador de eventos por cada boton
                        botones.forEach(boton => {    
                            boton.addEventListener("click", haceClick);
                        });
                    </script>


                    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.js"></script>
                    <script type="text/javascript" src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
                    <link type="text/css" rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/jquery.dataTables.min.css" />
                    <script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
                    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />

                    <script type="text/javascript" nonce="2726c7f26c">
                        $(function () {
                            var table = $('#table').DataTable
                            ({
                                //"ajax": { "url": "jsonArray.txt" },
                                "responsive": true,
                                "sPaginationType": "full_numbers",
                                "columnDefs": [
                                        { "targets": -1, "data": null, "defaultContent": "<button type='button' class='btn btn-primary' data-toggle='modal' data-target='#myModal'>"}
                                        
                                    ]
                            });
                     
                        });
                    </script>

            </p>
        </div>

    </div>

{% endblock %}











